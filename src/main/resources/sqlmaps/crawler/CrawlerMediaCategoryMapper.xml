<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.onemt.news.crawler.mysql.mapper.CrawlerMediaCategoryMapper">
	
	<!-- 源的分类统计 -->
	<select id="selectByFetchTimeForCategory" parameterType="HashMap"
		resultType="com.onemt.news.crawler.mysql.entity.MediaCategoryVo">
		SELECT
			IFNULL(
				m.mediaId,concat('新闻源总数:',CONVERT(count(distinct m.mediaId),char))
			) mediaId,
			IFNULL(
				m.id,
				(
					CASE
					WHEN m.mediaId IS NULL THEN
						CONCAT(
							'同源媒体总数:',
							count(DISTINCT m.id)
						)
					ELSE
						CONCAT(
							'同源:',
							m.processor,
							' 媒体总数:',
							count(DISTINCT m.id)
						)
					END
				)
			)
			id,
		
		IF (
			m.id IS NOT NULL,
		
		IF (
			m.extend = 'index',
			'排除index项',
			count(cc.id)
		),
		
		IF (
			m.mediaId IS NULL,
			CONCAT(
				'采集文章总数:',
				count(cc.id)
			),
			CONCAT(
				'该源',
				m.processor,
				'采集文章总数:',
				count(cc.id)
			)
		)
		) total
		FROM
			crawler_media_category m
		LEFT JOIN (
			SELECT
				c.mediaCategoryId,
				c.id
			FROM
				crawler_article c
			WHERE
				c.fetchTime BETWEEN UNIX_TIMESTAMP(#{date}) and  UNIX_TIMESTAMP(TIMESTAMPADD(DAY,1,#{date}))
		) cc ON m.id = cc.mediaCategoryId
		 where m.isEnable=1
		GROUP BY
			m.mediaId,
			m.id WITH ROLLUP
	</select>
	
	
	<!-- 源的统计 -->
	<select id="selectByFetchTimeForMedia" parameterType="HashMap"
		resultType="com.onemt.news.crawler.mysql.entity.MediaVo">
		SELECT
			ifnull(m.mediaid,CONCAT(
			<if test="type == null">
            '采集文章总数:'
        	</if>
        	<if test="type != null and type=='text'">
            '文本源采集总数:'
        	</if>
        	<if test="type != null and type=='gallery'">
            '图集源采集总数:'
        	</if>
        	<if test="type != null and type=='video'">
            '视频源采集文章总数:'
        	</if>
			)) id,
			count(cc.id) total
		FROM
			crawler_media_category m
		LEFT JOIN (
			SELECT
				c.id,
				c.mediaCategoryId
			FROM
				crawler_article c
			WHERE
				c.fetchTime BETWEEN UNIX_TIMESTAMP(#{date})
			AND UNIX_TIMESTAMP(TIMESTAMPADD(DAY,1,#{date}))
		) cc ON m.id = cc.mediaCategoryId
		WHERE
			m.isEnable = 1	
		<if test="type != null">
            and m.type=#{type}
        </if>
		GROUP BY
			m.mediaId WITH ROLLUP
	</select>

	
	<!-- 未开启采集的源 -->
	<select id="selectForMedia" parameterType="HashMap"
		resultType="com.onemt.news.crawler.mysql.entity.MediaOpenVo">
		select distinct m.mediaId id,m.type type from crawler_media_category m where m.isEnable=0 order by m.type,m.mediaId
	</select>

</mapper>